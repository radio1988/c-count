# C-COUNT

Colony count for colony formation assays. 

- All objects in the microscopic image will be detected as 'blobs', which includes colonies, undivided cells, debris, imaging artifacts, etc.
- One round of labeling would be needed for ccount to work. Decent classification/counting sensitivity and specificity can be achieved with 1-2 hours of labeling. When experiments are similar, we can re-use previous labeling
- Only the objects of interest (e.g. colonies) will be counted for the colony formation assay
- The size of the colonies (or other objects of interest) will also be reported
- This workflow can be adapted to the counting of other biological objects, given proper labeling

# Installation
- install mini-conda: https://docs.conda.io/en/latest/miniconda.html
- install mamba: https://anaconda.org/conda-forge/mamba  # optional
- install ccount-env: `mamba env create -n ccount-env -f workflow/env/mac.yaml`  # only tested in mac with M2 processer, works on Ubuntu with minor adaptations, docker image will be provided for easier installation

# Usage
## Labeling
- run `czi2img.py` on raw image and get jpg images with blobs detected (circles)
- use image editting software, e.g. 'preview', to put a red dot in all circles with a 'positive' colony.
- all blobs (circles) without red dots within will be treated as 'negatives'
- put raw and labeled images in the correct folder and run `jpg2npy.Snakefile`, e.g.  `snakemake -s workflow/jpg2npy.Snakefile -pk -j1`
- collect the npy.gz files (contains labeled blobs)

## Labeling adjustments (for advanced users)
- `labeling.ipynb`: adjusts labeling
- `crops_merging.py`: merge label files

## Training
- setup `config.train.yaml` and `config.yaml`
- run `train.Snakefile`, e.g. `snakemake -s workflow/train.Snakefile -pk -j1`
- collect `weight.hdf` for future use

## Counting
```
- mkdir $workdir && cd $workdir
- ln -s $path_data data
- ln -s $path_ccount/workflow
- conda activate ccount-env
- cp workflow/config.yaml ./ && vim config.yaml (edit config.yaml)
- cp workflow/config.data_curve.yaml ./ && vim config.data_curve.yaml 
- `snakemake -s workflow/count.Snakefile -pk -j 1` or `sh submit.sh` (on HPC)
```

## Brief Description of Key Scripts
- czi2img: read raw czi image, perform blob detection, save jpg image with detected blobs in gray circles
- crops_filtering.py: filter blob crops based on the labeling
- crops_merging.py: merge blob crop files
- get_label_statisticss.py: show statistics on crop files, especially the labels
- crops_viewing.py: view random samples from crop files

## Notations:
- plate: each plate loaded with cells and colonies
- raw image: each czi image that is generated by the microscope, usually combining one or several scenes from the plate
- scenes: in a raw image, there are typically four scenes, which are basically a scanned square areas of a plate. Usually, there are four scenes ("Top", "Left", "Right", "Bottom") in a plate. Sometimes only one scene is imaged.
- blobs: each object detected in an image, saved in npy format, each row is `[y, x, r, label]`
- crops: a square image with the blob in the center, saved in npy format, each row is `[y, x, r, label, area, place_holder, flattened cropped_blob_img]`

## Lab Tips:
- connect to workstation via ssh (terminal interface):
	- turn on jupyter-lab on the lab workstation
	- `ssh -L3333:localhost:8888Â  socolovsky_lab@IP` on your laptop
 	- go to `localhost:3333` in default browser to access jupyter-lab from your laptop

